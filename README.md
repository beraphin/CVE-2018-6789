# CVE-2018-6789

## 环境搭建
安装依赖
````shell
apt-get install gcc net-tools vim gdb python wget git make procps libpcre3-dev libdb-dev libxt-dev libxaw7-dev
````
下载旧版本的exim
```shell
wget ftp://mirror.easyname.at/exim-ftp/exim/exim4/old/exim-4.89.tar.gz
tar -xvzf ./exim-4.89.tar.gz
cd ./exim-4.89
cp src/EDITME Local/Makefile
cp exim_monitor/EDITME Local/eximon.conf
````
然后修改Local/Makefile
为了方便其中各个文件夹都指向当前目录下
````shell
BIN_DIRECTORY=/home/zzx/EVA/cve-2018-6789/exim-4.89/bin
CONFIGURE_FILE=/home/zzx/EVA/cve-2018-6789/exim-4.89/configure
SPOOL_DIRECTORY=/home/zzx/EVA/cve-2018-6789/exim-4.89/exim
EXIM_USER=zzx
AUTH_PLAINTEXT=yes
AUTH_CRAM_MD5=yes
AUTH_TLS=yes
````
修改OS/Makefile-Linux
````shell
CFLAGS ?= -O -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE
````
改为
````shell
CFLAGS ?= -g -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE
````

这样便于调试
然后编译安装
````shell
make install
````
修改./configure, 直接用下面内容覆盖
````shell
acl_smtp_mail=acl_check_mail
acl_smtp_data=acl_check_data
begin acl
acl_check_mail:
  .ifdef CHECK_MAIL_HELO_ISSUED
  deny
    message = no HELO given before MAIL command
    condition = ${if def:sender_helo_name {no}{yes}}
  .endif

  accept

acl_check_data:
  accept

begin authenticators
fixed_cram:
  driver = cram_md5
  public_name = CRAM-MD5
  server_secret = ${if eq{$auth1}{ph10}{secret}fail}
  server_set_id = $auth1
````

## 运行
````shell
./bin/exim -bd -d-receive
````
## 漏洞分析
首先先分析patch:
![1](images/1.png)
其中result是base64解码结果存放的buffer，由store_get函数获取
可以发现patch之前的size计算是有问题的，当size属于4n~4n+3的范围里面的时候，计算得到的size的长度是相等的，但是b64decode对于非4的倍数的参数进行解码的时候会多解出一两个字节

比如我们直接发送base64.b64encode('a'\*12)\
size=0x0d\
结果的内存分布:
```shell
pwndbg> hexdump 0x70cd88
+0000 0x70cd88  61 61 61 61  61 61 61 61  61 61 61 61  00 6c 6c 6f  │aaaa│aaaa│aaaa│.llo│
+0010 0x70cd98  20 6c 6f 63  61 6c 68 6f  73 74 20 5b  31 32 37 2e  │.loc│alho│st.[│127.│
+0020 0x70cda8  30 2e 30 2e  31 5d 0d 0a  32 35 30 2d  53 49 5a 45  │0.0.│1]..│250-│SIZE│
+0030 0x70cdb8  20 35 32 34  32 38 38 30  30 0d 0a 32  35 30 2d 38  │.524│2880│0..2│50-8│
```

再试试base64.b64encode('a'\*12)+'KKK'\
size=0x0d
```shell
pwndbg> hexdump 0x70cd88
+0000 0x70cd88  61 61 61 61  61 61 61 61  61 61 61 61  28 a2 6c 6f  │aaaa│aaaa│aaaa│(.lo│
+0010 0x70cd98  20 6c 6f 63  61 6c 68 6f  73 74 20 5b  31 32 37 2e  │.loc│alho│st.[│127.│
+0020 0x70cda8  30 2e 30 2e  31 5d 0d 0a  32 35 30 2d  53 49 5a 45  │0.0.│1]..│250-│SIZE│
+0030 0x70cdb8  20 35 32 34  32 38 38 30  30 0d 0a 32  35 30 2d 38  │.524│2880│0..2│50-8│
```
溢出了两个字节
## Reference
https://medium.com/@straightblast426/my-poc-walk-through-for-cve-2018-6789-2e402e4ff588
https://de4dcr0w.github.io/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2018-6789-Exim-Off-by-One%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html
https://github.com/skysider/VulnPOC/tree/master/CVE-2018-6789
